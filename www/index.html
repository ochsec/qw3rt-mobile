<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <!--
        Customize this policy to fit your own app's needs. For more guidance, please refer to the docs:
            https://cordova.apache.org/docs/en/latest/
        Some notes:
            * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
            * Disables use of inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
                * Enable inline JS: add 'unsafe-inline' to default-src
        -->
        <meta http-equiv="Content-Security-Policy" 
            content="default-src 'self' 'unsafe-inline' https://qw3rt.ochsec1.repl.co wss://qw3rt.ochsec1.repl.co data: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
        <meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="initial-scale=1, width=device-width>
        <meta name="color-scheme" content="light dark">
        <link rel="stylesheet" href="css/onsenui.min.css">
        <link rel="stylesheet" href="css/onsen-css-components.min.css">
        <link rel="stylesheet" href="css/index.css">
        <title>qw3rt</title>
    </head>
    <body>
        <ons-navigator id="qw3rtNav" page="index.html"></ons-navigator>

        <template id="index.html">
            <ons-page id="page-index">
                <div class="center">
                    <ons-toolbar>
                        <div class="center">qw3rt</div>
                    </ons-toolbar>
                    <ons-tabbar id="home-tabbar" position="bottom">
                        <ons-tab 
                            label="Create"
                            page="create.html" 
                            active
                        ></ons-tab>
                        <ons-tab 
                            label="Join"
                            page="join.html"
                        >
                        </ons-tab>                    
                    </ons-tabbar>
                </div>
                <script>
                    const API_URL = 'https://qw3rt.ochsec1.repl.co'
                    const navigator = document.getElementById('qw3rtNav')
                    let messages = []
                    let username, chatId, token, socketId

                    ons.ready(function() {
                        console.log(window.device)
                    })
    
                    document.addEventListener('init', function(event) {   
                        if (ons.platform.isIPhoneX()) { // Utility function
                            // Add empty attribute to the <html> element
                            document.documentElement.setAttribute('onsflag-iphonex-portrait', '')
                            document.querySelector('#home-tabbar').setAttribute('class', 'iphone-x')
                        }
    
                        if (ons.platform.isIPhoneX()) { // Utility function
                            // Add empty attribute to the <html> element
                            document.documentElement.setAttribute('onsflag-iphonex-landscape', '')
                        }
    
                        // Hide errors
                        document.querySelectorAll('.username-errors')
                            .forEach((el) => el.style.visibility = 'hidden')
                        document.querySelectorAll('.chatid-errors')
                            .forEach((el) => el.style.visibility = 'hidden')

                        var page = event.target

                        if (page.matches('#page-chat')) {
                            const chatIdFromRedirect = navigator.topPage.data.chatId
                            username = sessionStorage.getItem('username')
                            chatId = sessionStorage.getItem('chatId')
                            token = sessionStorage.getItem('token')

                            if (!username || !token) {
                                navigator.pushPage('index.html')
                            }

                            if (!chatId || (chatId !== chatIdFromRedirect)) {
                                navgiator.pushPage('index.html')
                            }

                            fetch(API_URL + '/' + chatId, {
                                method: 'POST',
                                cache: 'no-cache',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                        username,
                                        chatId,
                                        token
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'error') {
                                        navigator.pushPage('index.html')
                                    } else {
                                        messages: data.content
                                        console.log('verified')
                                    }
                                })
                            }
                        })
                </script>
              </ons-page>
        </template>

        <template id="create.html">
            <ons-page id="page-create">
                <div style="margin-top: 200px;">
                    <ons-card class="center">
                        <h4>Create Private Chat</h4>
                        <p>
                            <label for="create-username">Username</label>
                        </p>
                        <p>
                            <ons-input 
                                id="create-username"                                
                                modifier="underbar"
                                float
                            ></ons-input>
                        </p>
                        <p>
                            <label id="create-username-errors" style="visibility: hidden;">
                                Please enter a username
                            </label>
                        </p>
                        <p>
                            <ons-button id="create-btn" onclick="onCreateClicked">Create</ons-button>
                        </p>
                    </ons-card>
                </div>
                <script src="js/create.js"></script>
            </ons-page>
        </template>
        
        <template id="join.html">
            <ons-page id="page-join">
                <div style="margin-top: 200px;">
                    <ons-card class="center">
                        <h4>Join Private Chat</h4>
                        <label for="join-username">Username</label>
                        <p>
                            <ons-input 
                                id="join-username"
                                modifier="underbar"
                                float
                            ></ons-input>
                        </p>
                        <p>
                            <label id="join-username-errors" style="visibility: hidden;">
                                Please enter a username
                            </label>
                        </p>
                        <p>
                            <label for="chatid">Chat Id</label>
                        </p>
                        <p>
                            <ons-input
                                id="join-chatid"
                                modifier="underbar"
                                float
                            >
                        </p>
                        <p>
                            <label id="join-chatid-errors" style="visibility: hidden;">
                                Please enter a chat id
                            </label>
                        </p>
                        <p>
                            <ons-button>Join</ons-button>
                        </p>
                    </ons-card>
                </div>
                <script src="js/join.js"></script>
            </ons-page>
        </template>

        <template id="chat.html">
            <ons-page id="page-chat">
                <ons-toolbar>
                    <div class="center">chat</div>
                </ons-toolbar>
                <script src="js/chat.js"></script>            
            </ons-page>
        </template>

        <script src="cordova.js"></script>
        <script src="js/onsenui.min.js"></script>
        <!-- <script src="js/sockjs.min.js"></script> -->
        <script src="js/index.js"></script>
    </body>
</html>
